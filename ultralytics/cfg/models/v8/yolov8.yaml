# hybrid_nano.yaml
task: "pose"
nc: 1
kpt_shape: [21,3]
scale: "n"              # target ~9 GFLOPs

# ------------------------------------------
# Backbone (0–12): P1→P5 with DWConv + ECA + CoordAtt
# ------------------------------------------
backbone:
  - [-1,  1, Conv,     [16, 3, 2]]    # 0: P1/2 (stem)
  - [-1,  2, DWConv,   [32, 3, 2]]    # 1: P2/4 (dwconv×2)
  - [-1,  1, ECA,      [32, 3]]       # 2: ECA@P2
  - [-1,  2, C2f,      [32, True]]    # 3: C2f refine P2

  - [-1,  2, DWConv,   [64, 3, 2]]    # 4: P3/8 (dwconv×2)
  - [-1,  1, CoordAtt, [64]]          # 5: CoordAtt@P3
  - [-1,  2, C2f,      [64, True]]    # 6: C2f refine P3

  - [-1,  2, DWConv,   [128, 3, 2]]   # 7: P4/16 (dwconv×2)
  - [-1,  1, CoordAtt, [128]]         # 8: CoordAtt@P4
  - [-1,  2, C2f,      [128, True]]   # 9: C2f refine P4

  - [-1,  2, DWConv,   [256, 3, 2]]   #10: P5/32 (dwconv×2)
  - [-1,  1, ECA,      [256, 3]]      #11: ECA@P5
  - [-1,  1, SPPF,     [256, 5]]      #12: SPPF pooling

# ------------------------------------------
# Neck (13–24): 2-layer BiFPN-style
# ------------------------------------------
head:
  # P5 → P4
  - [-1,  1, nn.Upsample, [None,2,'nearest']]  #13: up P5
  - [[13,  9], 1, Concat, [1]]                  #14: fuse with refine_P4 (idx9)
  - [-1,  2, C2f,      [128, True]]            #15: refine fused P4

  # P4 → P3
  - [-1,  1, nn.Upsample, [None,2,'nearest']]  #16: up fused P4
  - [[16,  6], 1, Concat, [1]]                  #17: fuse with refine_P3 (idx6)
  - [-1,  2, C2f,      [64, True]]             #18: refine fused P3

  # P3 → P4 down
  - [-1,  1, Conv,     [64, 3, 2]]             #19: downsample ref_P3 (idx18) to P4
  - [[19, 15], 1, Concat, [1]]                  #20: fuse with up-refined P4 (idx15)
  - [-1,  2, C2f,      [128, True]]            #21: refine P4 again

  # P4 → P5 down
  - [-1,  1, Conv,     [128,3, 2]]             #22: downsample ref_P4 (idx21) to P5
  - [[22, 12], 1, Concat, [1]]                  #23: fuse with original P5 (idx12)
  - [-1,  2, C2f,      [256, True]]            #24: refine P5 again

# ------------------------------------------
# Heads (Detect + Pose)
# ------------------------------------------
  # Detect on P3 (18), P4 (21), P5 (24)
  - [[18, 21, 24], 1, Detect, [nc]]             #25

  # High-res Pose on P3
  - [18, 1, Conv,     [64, 1, 1]]               #26
  - [-1, 1, Pose,     [nc, kpt_shape]]          #27

  # Coarse Pose on P5
  - [24, 1, Conv,     [128,1,1]]                #28
  - [-1, 1, Pose,     [nc, kpt_shape]]          #29
